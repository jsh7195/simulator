<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1338813848148433"
        crossorigin="anonymous"></script>
    <title>í”„ë¼ì‹œì•„ ì „ê¸° ì§‘í–‰ê´€ ì „ìŠ¹ ì‹œë®¬ë ˆì´í„°</title>
    <!-- <og:title>í”„ë¼ì‹œì•„ ì „ê¸° ì§‘í–‰ê´€ ì „ìŠ¹ ì‹œë®¬ë ˆì´í„°</og:title> -->
    <!-- <og:description>í”„ë¼ì‹œì•„ ì „ê¸° ì§‘í–‰ê´€ ì „ìŠ¹ ì‹œë®¬ë ˆì´í„°</og:description> -->
    <style>
        /* ì´ˆê¸° ë¸”ë¡œê·¸ ì˜ì—­ì—ì„œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ì´ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ìˆ˜ì • */
        body {
            margin: 0;
        }

        .skill-tree-wrapper {
            position: 'fixed';
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f0f 70%, #000000 100%);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            color: #ffffff;
            position: relative;

            /* ìµœì†Œ í¬ê¸° ë³´ì¥ */
            /* min-width: 320px;
            min-height: 400px; */
        }

        .skill-tree-wrapper .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00aaff;
            border-radius: 8px;
            padding: 10px;
            /* íŒ¨ë”© ì¤„ì„ */
            color: #ffffff;
            font-size: 12px;
            /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
            backdrop-filter: blur(5px);
            box-sizing: border-box;

            /* í•µì‹¬: ì»¨í…Œì´ë„ˆë¥¼ ì ˆëŒ€ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ */
            max-width: calc(100% - 20px);
            max-height: calc(100% - 40px);
            overflow: auto;
            /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
        }

        .skill-tree-wrapper .controls-panel {
            top: 10px;
            left: 10px;

            /* ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë”°ë¼ ìë™ ì¡°ì • */
            width: auto;
            max-width: calc(100% - 20px);
        }

        .skill-tree-wrapper .points-panel {
            bottom: 10px;
            left: 10px;

            /* ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë”°ë¼ ìë™ ì¡°ì • */
            width: auto;
            max-width: calc(100% - 20px);
        }

        /* ë²„íŠ¼ í¬ê¸°ë„ ì‘ê²Œ ì¡°ì • */
        .skill-tree-wrapper button {
            background: linear-gradient(45deg, #003366, #006699);
            border: 1px solid #00aaff;
            color: white;
            padding: 6px 10px;
            /* íŒ¨ë”© ì¤„ì„ */
            margin: 2px;
            /* ë§ˆì§„ ì¤„ì„ */
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
            font-family: inherit;
            transition: all 0.3s;
            white-space: nowrap;
            /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        /* ì…ë ¥ í•„ë“œë„ ì‘ê²Œ */
        .skill-tree-wrapper input[type="number"] {
            background: rgba(0, 50, 100, 0.3);
            border: 1px solid #00aaff;
            color: #ffffff;
            padding: 4px 6px;
            /* íŒ¨ë”© ì¤„ì„ */
            border-radius: 3px;
            width: 60px;
            /* ë„ˆë¹„ ì¤„ì„ */
            font-family: inherit;
            font-size: 11px;
            /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë‚´ìš© ì¡°ì • */
        .skill-tree-wrapper .input-group {
            margin: 5px 0;
            /* ë§ˆì§„ ì¤„ì„ */
            display: flex;
            align-items: center;
            gap: 5px;
            /* ê°„ê²© ì¤„ì„ */
            flex-wrap: wrap;
            /* ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ì¤„ë°”ê¿ˆ */
        }

        /* ì œëª© í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
        .skill-tree-wrapper .ui-panel>div:first-child {
            font-size: 11px;
            margin-bottom: 5px;
        }

        /* ì•„ì£¼ ì‘ì€ í™”ë©´ì—ì„œì˜ ëŒ€ì‘ */
        @media (max-width: 400px) {
            .skill-tree-wrapper .ui-panel {
                padding: 8px;
                font-size: 10px;
            }

            .skill-tree-wrapper button {
                padding: 4px 6px;
                font-size: 9px;
                margin: 1px;
            }

            .skill-tree-wrapper input[type="number"] {
                width: 45px;
                padding: 3px 4px;
                font-size: 10px;
            }

            .skill-tree-wrapper .controls-panel,
            .skill-tree-wrapper .points-panel {
                left: 5px;
                max-width: calc(100% - 10px);
            }

            .skill-tree-wrapper .controls-panel {
                top: 5px;
            }

            .skill-tree-wrapper .points-panel {
                bottom: 5px;
            }
        }

        /* ì‘ì€ ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ëŒ€í•œ ì¶”ê°€ ëŒ€ì‘ */
        .skill-tree-wrapper {
            container-type: inline-size;
        }

        @container (max-width: 500px) {
            .skill-tree-wrapper .ui-panel {
                padding: 8px;
                font-size: 11px;
            }

            .skill-tree-wrapper button {
                padding: 5px 8px;
                font-size: 10px;
            }
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ë“¤ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì¡°ì • */
        .skill-tree-wrapper .controls-panel {
            z-index: 11;
        }

        .skill-tree-wrapper .points-panel {
            z-index: 10;
        }
    </style>
</head>

<div class="skill-tree-wrapper">
    <div class="ui-panel controls-panel">
        <div style="color: #00ffff; font-weight: bold; margin-bottom: 10px;">ğŸ® ì»¨íŠ¸ë¡¤</div>
        <!-- <button onclick="toggleCoordinateMode()">ğŸ“ ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œ</button>
        <button onclick="toggleConnectionMode()">ğŸ”— ì—°ê²° ëª¨ë“œ</button> -->
        <button onclick="resetSkillTree()">ğŸ”„ ë¦¬ì…‹</button>
        <button onclick="saveToFile()">ğŸ’¾ ì €ì¥</button>
        <button onclick="loadFromFile()">ğŸ“ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageLoad(event)">
        <!-- <button onclick="loadImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</button> -->
    </div>

    <div id="root-point-panel" class="ui-panel points-panel">
        <div style="color: #ffaa00; font-weight: bold; margin-bottom: 10px;">ğŸ’ í¬ì¸íŠ¸</div>
        <div class="input-group">
            <label>ì‚¬ìš© ê°€ëŠ¥:</label>
            <input type="number" id="pointsInput" value="50" min="0" max="999" onchange="updatePoints()">
            <button onclick="addPoints(10)">+10</button>
        </div>
        <div style="margin-top: 10px;">
            <div>ì‚¬ìš©ë¨: <span id="usedPoints" class="status-text">0</span></div>
            <div>ì´ í¬ì¸íŠ¸: <span id="totalPoints" class="status-text">50</span></div>
        </div>
    </div>

    <!-- ì—°ê²° ëª¨ë“œ íŒ¨ë„ -->
    <!-- <div id="connectionPanel" class="ui-panel" style="top: 20px; left: 500px; display: none;">
        <div style="color: #00ffff; font-weight: bold; margin-bottom: 10px;">ğŸ”— ì—°ê²° ëª¨ë“œ</div>
        <div style="margin-bottom: 10px;">
            <span style="color: #ffaa00;">ìƒíƒœ:</span>
            <span id="connectionStatus" style="color: #ff6666;">ë¹„í™œì„±</span>
        </div>
        <div style="margin-bottom: 10px;">
            <span style="color: #ffaa00;">ì„ íƒëœ ë…¸ë“œ:</span>
            <span id="selectedNode" style="color: #00ff88;">ì—†ìŒ</span>
        </div>
        <div style="margin-bottom: 10px;">
            <input type="checkbox" id="bidirectionalCheck" checked>
            <label for="bidirectionalCheck" style="margin-left: 5px;">ì–‘ë°©í–¥ ì—°ê²°</label>
        </div>
        <div style="margin-bottom: 10px;">
            <div>ì´ ì—°ê²°: <span id="connectionCount" style="color: #00ff88;">0</span>ê°œ</div>
        </div>
        <button onclick="exportConnections()">ğŸ“‹ ì—°ê²° ì½”ë“œ ë³µì‚¬</button>
        <button onclick="clearAllConnections()">ğŸ—‘ï¸ ëª¨ë“  ì—°ê²° ì‚­ì œ</button>

        <div id="connectionList"
            style="max-height: 200px; overflow-y: auto; margin-top: 10px; font-size: 12px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 3px;">
        </div>
    </div> -->
    <!-- ì¢Œí‘œ ìˆ˜ì§‘ íŒ¨ë„ -->
    <!-- <div id="coordinatePanel" class="ui-panel" style="top: 20px; left: 300px; display: none;">
        <div style="color: #00ffff; font-weight: bold; margin-bottom: 10px;">ğŸ“ ì¢Œí‘œ ìˆ˜ì§‘ê¸°</div>
        <div style="margin-bottom: 10px;">
            <span style="color: #ffaa00;">ëª¨ë“œ:</span>
            <span id="modeStatus" style="color: #ff6666;">ë¹„í™œì„±</span>
        </div>
        <div style="margin-bottom: 10px;">
            <label>ë…¸ë“œ íƒ€ì…:</label>
            <select id="nodeTypeSelect"
                style="background: rgba(0,50,100,0.3); border: 1px solid #00aaff; color: white; padding: 4px;">
                <option value="small">Small</option>
                <option value="notable">Notable</option>
                <option value="keystone">Keystone</option>
            </select>
        </div>
        <div style="margin-bottom: 10px;">
            <div>ìˆ˜ì§‘ëœ ì¢Œí‘œ: <span id="coordinateCount" style="color: #00ff88;">0</span>ê°œ</div>
        </div>
        <button onclick="exportCoordinates()">ğŸ“‹ ì¢Œí‘œ ë³µì‚¬</button>
        <button onclick="clearCoordinates()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        <button onclick="generateNodes()">âš¡ ë…¸ë“œ ìƒì„±</button>

        <div id="coordinateList"
            style="max-height: 200px; overflow-y: auto; margin-top: 10px; font-size: 12px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 3px;">
        </div>
    </div> -->

    <canvas id="canvas"></canvas>


    <script>

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ê²Œì„ ìƒíƒœ
        let availablePoints = 50;
        let usedPoints = 0;
        let camera = { x: 0, y: 0, zoom: 1.2 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œ
        let coordinateMode = false;
        let collectedCoordinates = [];
        let backgroundImage = null;
        let imageLoaded = false;

        // ì—°ê²° ëª¨ë“œ
        let connectionMode = false;
        let selectedNode = null;
        let allConnections = [];

        // í‚¤ë³´ë“œ ì´ë™
        const keys = {};
        window.addEventListener('keydown', (e) => { keys[e.code] = true; });
        window.addEventListener('keyup', (e) => { keys[e.code] = false; });

        function handleKeyboardMovement() {
            const speed = 3 / camera.zoom;
            if (keys['KeyW'] || keys['ArrowUp']) camera.y += speed;
            if (keys['KeyS'] || keys['ArrowDown']) camera.y -= speed;
            if (keys['KeyA'] || keys['ArrowLeft']) camera.x += speed;
            if (keys['KeyD'] || keys['ArrowRight']) camera.x -= speed;
        }

        // ë…¸ë“œ í´ë˜ìŠ¤
        class SkillNode {
            constructor(x, y, id, type = 'small', maxLevel = 1, prerequisites = [], name = '') {
                this.x = x;
                this.y = y;
                this.id = id;
                this.type = type; // 'small', 'notable', 'keystone'
                this.currentLevel = 0;
                this.maxLevel = maxLevel;
                this.connections = [];
                this.prerequisites = prerequisites;
                this.radius = this.getRadius();
                this.name = name;
            }

            getRadius() {
                switch (this.type) {
                    case 'small': return 38;
                    case 'notable': return 44;
                    case 'keystone': return 80;
                    default: return 38;
                }
            }

            addConnection(nodeId) {
                if (!this.connections.includes(nodeId)) {
                    this.connections.push(nodeId);
                }
            }

            addPrerequisite(nodeId) {
                if (!this.prerequisites.includes(nodeId)) {
                    this.prerequisites.push(nodeId);
                }
            }

            canActivate() {
                // 1. í˜„ì¬ ë…¸ë“œê°€ ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì´ë©´ ë¹„í™œì„±í™”
                if (this.currentLevel >= this.maxLevel) return false;

                // 2. ê°€ìš© í¬ì¸íŠ¸ê°€ ì—†ìœ¼ë©´ ë¹„í™œì„±í™”
                if (availablePoints <= 0) return false;

                // 3. node_5ëŠ” í•­ìƒ í™œì„±í™” ê°€ëŠ¥
                if (this.id === 'node_5') return true;

                // 4. node_5ê°€ ìµœëŒ€ ë ˆë²¨ì´ ì•„ë‹ˆë©´ ë‚˜ë¨¸ì§€ ë…¸ë“œëŠ” ë¹„í™œì„±í™”
                const node5 = nodes.find(n => n.id === 'node_5');
                if (!node5 || node5.currentLevel < node5.maxLevel) return false;

                // 5. ì „ì œì¡°ê±´ì´ ì—†ëŠ” ê²½ìš°: ì‹œì‘ ë…¸ë“œê°€ ì•„ë‹ˆë©´ ë¹„í™œì„±í™”
                if (this.prerequisites.length === 0) {
                    return false;
                }

                // 6. ëª¨ë“  ì „ì œ ì¡°ê±´ì´ maxLevelì´ì–´ì•¼ í™œì„±í™” ê°€ëŠ¥
                return this.prerequisites.every(prereqId => {

                    const prereqNode = nodes.find(n => n.id === prereqId);

                    return prereqNode && prereqNode.currentLevel >= prereqNode.maxLevel;
                });
            }

            activate() {
                if (this.canActivate()) {
                    this.currentLevel++;
                    availablePoints--;
                    usedPoints++;
                    updateUI();
                    saveToLocalStorage();
                    return true;
                }
                return false;
            }

            deactivate() {
                if (this.currentLevel <= 0) return false;

                // ë‹¤ë¥¸ ë…¸ë“œì˜ ì „ì œì¡°ê±´ì´ ë˜ëŠ”ì§€ í™•ì¸
                const dependentNodes = nodes.filter(node =>
                    node.prerequisites.includes(this.id) && node.currentLevel > 0
                );

                if (dependentNodes.length > 0) {
                    return false; // ì¢…ì† ë…¸ë“œê°€ ìˆìœ¼ë©´ ë¹„í™œì„±í™” ë¶ˆê°€
                }

                this.currentLevel--;
                availablePoints++;
                usedPoints--;
                updateUI();
                saveToLocalStorage();
                return true;
            }

            getScreenPosition() {
                return {
                    x: (this.x + camera.x) * camera.zoom + canvas.width / 2,
                    y: (this.y + camera.y) * camera.zoom + canvas.height / 2
                };
            }

            isPointInside(screenX, screenY) {
                const pos = this.getScreenPosition();
                const distance = Math.sqrt(
                    Math.pow(screenX - pos.x, 2) + Math.pow(screenY - pos.y, 2)
                );
                return distance <= this.radius * camera.zoom;
            }

            draw() {
                const pos = this.getScreenPosition();
                const scaledRadius = this.radius * camera.zoom;

                // ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
                let fillColor, strokeColor, glowColor;
                const isActive = this.currentLevel > 0;
                const canLevel = this.canActivate();

                if (isActive) {
                    fillColor = '#00ff88';
                    strokeColor = '#ffffff';
                    glowColor = '#00ff88';
                } else if (canLevel) {
                    fillColor = '#003366';
                    strokeColor = '#00aaff';
                    glowColor = '#00aaff';
                } else {
                    fillColor = '#1a1a1a';
                    strokeColor = '#666666';
                    glowColor = null;
                }

                // ê¸€ë¡œìš° íš¨ê³¼
                if (glowColor) {
                    ctx.shadowColor = glowColor;
                    ctx.shadowBlur = canLevel ? 10 : 6;
                } else {
                    ctx.shadowBlur = 0;
                }

                // ë…¸ë“œ íƒ€ì…ì— ë”°ë¥¸ ëª¨ì–‘ ê·¸ë¦¬ê¸°
                if (this.type === 'keystone') {
                    // í‚¤ìŠ¤í†¤: ì›í˜•
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, scaledRadius, 0, Math.PI * 2);
                    ctx.fillStyle = fillColor;
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = strokeColor;
                    ctx.stroke();

                    // ë‚´ë¶€ ì›
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, scaledRadius - 4, 0, Math.PI * 2);
                    ctx.strokeStyle = '#ffaa00';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                } else {
                    // ì¼ë°˜ ë…¸ë“œ: ìœ¡ê°í˜•
                    ctx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i;
                        const x = pos.x + Math.cos(angle) * scaledRadius;
                        const y = pos.y + Math.sin(angle) * scaledRadius;
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.closePath();
                    ctx.fillStyle = fillColor;
                    ctx.fill();
                    ctx.lineWidth = 1.5;
                    ctx.strokeStyle = strokeColor;
                    ctx.stroke();
                }

                ctx.shadowBlur = 0;

                // ë ˆë²¨ í‘œì‹œ (maxLevel > 1ì¸ ê²½ìš°ë§Œ)
                if (this.maxLevel > 0) {
                    ctx.fillStyle = isActive ? '#000000' : '#ffffff';
                    ctx.font = `${Math.min(30, scaledRadius * 5)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${this.currentLevel}/${this.maxLevel}`, pos.x, pos.y); // ë ˆë²¨ì •ë³´
                    ctx.fillStyle = '#ffffff';

                    let defaultHeight = 50;
                    switch (this.type) {
                        case "small":
                            
                            break;
                        case "notable":
                            defaultHeight = 55
                            break;
                                case "keystone":
                            defaultHeight = 90
                            break;
                        default:
                            defaultHeight = 50;
                            break;
                    }

                    ctx.fillText(`${this.name}`, pos.x, pos.y + (defaultHeight * camera.zoom)); // idì •ë³´
                }
            }
        }

        // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
        function drawConnection(fromNode, toNode) {
            const fromPos = fromNode.getScreenPosition();
            const toPos = toNode.getScreenPosition();

            // ì—°ê²°ì„  í™œì„±í™” ì¡°ê±´
            const isActive = fromNode.currentLevel > 0 || toNode.currentLevel > 0 || toNode.canActivate();

            ctx.beginPath();
            ctx.moveTo(fromPos.x, fromPos.y);
            ctx.lineTo(toPos.x, toPos.y);

            if (isActive) {
                ctx.shadowColor = '#00aaff';
                ctx.shadowBlur = 6;
                ctx.strokeStyle = '#00aaff';
                ctx.lineWidth = 2;
            } else {
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 1;
            }

            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        // ë…¸ë“œ ë°°ì—´ (ì—¬ê¸°ì— 43ê°œ ë…¸ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”)
        const nodes = [];

        // ìƒ˜í”Œ ë…¸ë“œ - ì´ í˜•ì‹ìœ¼ë¡œ 43ê°œ ë…¸ë“œë¥¼ ìƒì„±í•˜ì„¸ìš”
        // new SkillNode(xì¢Œí‘œ, yì¢Œí‘œ, 'node_id', 'ë…¸ë“œíƒ€ì…', ìµœëŒ€ë ˆë²¨)
        // ë…¸ë“œíƒ€ì…: 'small', 'notable', 'keystone'
        // ----------------node info--------------------
        // nodes.push(new SkillNode(-960, -95, 'node_1', 'notable', 1, ['node_5']));
        // nodes.push(new SkillNode(-803, -271, 'node_2', 'notable', 1, ['node_5']));
        // nodes.push(new SkillNode(-554, -406, 'node_3', 'notable', 1, ['node_5']));
        // nodes.push(new SkillNode(-709, 15, 'node_4', 'notable', 1, ['node_5']));
        // nodes.push(new SkillNode(-552, -165, 'node_5', 'keystone', 5));
        // nodes.push(new SkillNode(-381, -310, 'node_6', 'small', 5, ['node_5']));
        // nodes.push(new SkillNode(-328, -184, 'node_7', 'small', 5, ['node_5']));
        // nodes.push(new SkillNode(-343, -448, 'node_8', 'notable', 1, ['node_6']));
        // nodes.push(new SkillNode(-413, -74, 'node_9', 'notable', 1, ['node_7']));
        // nodes.push(new SkillNode(-333, -9, 'node_10', 'notable', 1, ['node_9']));
        // nodes.push(new SkillNode(-145, -149, 'node_11', 'notable', 1, ['node_37','node_33']));

        nodes.push(new SkillNode(-960, -95, 'node_1', 'notable', 1, [], 'ë°©ì–´ë§‰'));
        nodes.push(new SkillNode(-803, -271, 'node_2', 'notable', 1, [], 'ì í™”'));
        nodes.push(new SkillNode(-554, -406, 'node_3', 'notable', 1, [], 'ë°©ì–´ë§‰ íŒŒê´´'));
        nodes.push(new SkillNode(-709, 15, 'node_4', 'notable', 1, [], 'ë¬´íš¨í™”'));
        nodes.push(new SkillNode(-552, -165, 'node_5', 'keystone', 5,[], 'HP'));
        nodes.push(new SkillNode(-381, -310, 'node_6', 'small', 5));
        nodes.push(new SkillNode(-328, -184, 'node_7', 'small', 5));
        nodes.push(new SkillNode(-343, -448, 'node_8', 'notable', 1));
        nodes.push(new SkillNode(-413, -74, 'node_9', 'notable', 1, [], 'ëŒì§„'));
        nodes.push(new SkillNode(-333, -9, 'node_10', 'notable', 1, [], 'ìœ í‹¸ ìŠ¬ë¡¯'));
        nodes.push(new SkillNode(-145, -149, 'node_11', 'notable', 1, [], 'ì‹ ì˜ë°©íŒ¨'));
        nodes.push(new SkillNode(-62, -401, 'node_12', 'notable', 1, [], 'ì¹´ë°ë‚˜'));
        nodes.push(new SkillNode(193, -372, 'node_13', 'notable', 1, [], 'ê³µê²©ì˜¤ë¼'));
        nodes.push(new SkillNode(38, -669, 'node_14', 'notable', 1, [], 'ìê°€íšŒë³µê´‘ì—­1'));
        nodes.push(new SkillNode(154, -594, 'node_15', 'notable', 3,[],'í—Œì‹ íŠ¹í™”'));
        nodes.push(new SkillNode(31, -831, 'node_16', 'notable', 1,[],'ìê°€íšŒë³µê°•í™”1'));
        nodes.push(new SkillNode(273, -829, 'node_17', 'notable', 1,[],'ìê°€íšŒë³µê°•í™”2'));
        nodes.push(new SkillNode(395, -742, 'node_18', 'notable', 1,[],'ìê°€íšŒë³µê´‘ì—­2'));
        nodes.push(new SkillNode(591, -230, 'node_19', 'notable', 1, [], 'ì°¸íšŒì˜ ë„ë¼'));
        nodes.push(new SkillNode(296, 85, 'node_20', 'notable', 1, [], 'ì§•ë²Œì˜ ë„ì•½'));
        nodes.push(new SkillNode(179, 132, 'node_21', 'notable', 3, [], 'ìˆ˜í˜¸íŠ¹í™”'));
        nodes.push(new SkillNode(128, -179, 'node_22', 'notable', 1, [], 'ì‚¬ìŠ¬ì†ë°•'));
        nodes.push(new SkillNode(-137, 238, 'node_23', 'notable', 1, [], 'ëŒì§„ë°©ì–´1'));
        nodes.push(new SkillNode(-490, 331, 'node_24', 'notable', 1, [], 'ëŒì§„ê³µê²©1'));
        nodes.push(new SkillNode(-234, 558, 'node_25', 'notable', 1, [], 'ëŒì§„ê³µê²©2'));
        nodes.push(new SkillNode(-14, 513, 'node_26', 'notable', 1, [], 'ëŒì§„ë°©ì–´2'));
        nodes.push(new SkillNode(716, 52, 'node_27', 'keystone', 3, [], 'ì‹¬íŒíŠ¹í™”'));
        nodes.push(new SkillNode(489, -944, 'node_28', 'keystone', 5,[],'íšŒë³µì¦í­'));
        nodes.push(new SkillNode(3, 698, 'node_29', 'keystone', 5, [], 'ìƒì '));
        nodes.push(new SkillNode(-318, 264, 'node_30', 'small', 5));
        nodes.push(new SkillNode(-234, 127, 'node_31', 'small', 5));
        nodes.push(new SkillNode(-44, 69, 'node_32', 'small', 5));
        nodes.push(new SkillNode(-173, -59, 'node_33', 'small', 5));
        nodes.push(new SkillNode(3, -50, 'node_34', 'small', 5, [], 'ê¸°ì ˆì ì¤‘'));
        nodes.push(new SkillNode(202, -44, 'node_35', 'small', 5));
        nodes.push(new SkillNode(268, -192, 'node_36', 'small', 5));
        nodes.push(new SkillNode(-32, -232, 'node_37', 'small', 5));
        nodes.push(new SkillNode(-212, -530, 'node_38', 'small', 5));
        nodes.push(new SkillNode(17, -481, 'node_39', 'small', 5));
        nodes.push(new SkillNode(-91, -737, 'node_40', 'small', 5));
        nodes.push(new SkillNode(270, -671, 'node_41', 'small', 5));
        nodes.push(new SkillNode(157, -894, 'node_42', 'small', 5));
        nodes.push(new SkillNode(425, -346, 'node_43', 'small', 5));
        nodes.push(new SkillNode(-268, 421, 'node_44', 'small', 5));
        nodes.push(new SkillNode(-91, 389, 'node_45', 'small', 5));
        nodes.push(new SkillNode(-3, 279, 'node_46', 'small', 5));



        // ------------------------------------

        // ì—°ê²° ê´€ê³„ ì„¤ì • í•¨ìˆ˜ (ë…¸ë“œ ì¶”ê°€ í›„ ì—°ê²° ì„¤ì •)
        function setupConnections() {

            // ë¨¼ì € ëª¨ë“  ë…¸ë“œì˜ ì—°ê²°ê³¼ ì „ì œì¡°ê±´ì„ ì´ˆê¸°í™”
            nodes.forEach(node => {
                node.connections = [];
                node.prerequisites = [];
            });
            nodes.find(n => n.id === 'node_5').addConnection('node_1');
            nodes.find(n => n.id === 'node_1').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_5').addConnection('node_2');
            nodes.find(n => n.id === 'node_2').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_5').addConnection('node_3');
            nodes.find(n => n.id === 'node_3').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_5').addConnection('node_4');
            nodes.find(n => n.id === 'node_4').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_5').addConnection('node_4');
            nodes.find(n => n.id === 'node_4').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_5').addConnection('node_6');
            nodes.find(n => n.id === 'node_6').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_5').addConnection('node_7');
            nodes.find(n => n.id === 'node_7').addPrerequisite('node_5');

            nodes.find(n => n.id === 'node_7').addConnection('node_9');
            nodes.find(n => n.id === 'node_9').addPrerequisite('node_7');

            nodes.find(n => n.id === 'node_9').addConnection('node_10');
            nodes.find(n => n.id === 'node_10').addPrerequisite('node_9');

            nodes.find(n => n.id === 'node_10').addConnection('node_33');
            nodes.find(n => n.id === 'node_33').addPrerequisite('node_10');

            nodes.find(n => n.id === 'node_33').addConnection('node_31');
            nodes.find(n => n.id === 'node_31').addPrerequisite('node_33');

            nodes.find(n => n.id === 'node_33').addConnection('node_11');
            nodes.find(n => n.id === 'node_11').addPrerequisite('node_33');
            nodes.find(n => n.id === 'node_37').addConnection('node_11');
            nodes.find(n => n.id === 'node_37').addPrerequisite('node_11');

            nodes.find(n => n.id === 'node_31').addConnection('node_30');
            nodes.find(n => n.id === 'node_30').addPrerequisite('node_31');

            nodes.find(n => n.id === 'node_30').addConnection('node_24');
            nodes.find(n => n.id === 'node_24').addPrerequisite('node_30');

            nodes.find(n => n.id === 'node_24').addConnection('node_44');
            nodes.find(n => n.id === 'node_44').addPrerequisite('node_24');

            nodes.find(n => n.id === 'node_6').addConnection('node_8');
            nodes.find(n => n.id === 'node_8').addPrerequisite('node_6');

            nodes.find(n => n.id === 'node_8').addConnection('node_38');
            nodes.find(n => n.id === 'node_38').addPrerequisite('node_8');

            nodes.find(n => n.id === 'node_38').addConnection('node_12');
            nodes.find(n => n.id === 'node_12').addPrerequisite('node_38');

            nodes.find(n => n.id === 'node_12').addConnection('node_37');
            nodes.find(n => n.id === 'node_37').addPrerequisite('node_12');

            // nodes.find(n => n.id === 'node_37').addConnection('node_12');
            // nodes.find(n => n.id === 'node_12').addPrerequisite('node_37');




            nodes.find(n => n.id === 'node_44').addConnection('node_25');
            nodes.find(n => n.id === 'node_25').addPrerequisite('node_44');

            nodes.find(n => n.id === 'node_25').addConnection('node_29');
            nodes.find(n => n.id === 'node_29').addPrerequisite('node_25');

            nodes.find(n => n.id === 'node_31').addConnection('node_23');
            nodes.find(n => n.id === 'node_23').addPrerequisite('node_31');

            nodes.find(n => n.id === 'node_23').addConnection('node_46');
            nodes.find(n => n.id === 'node_46').addPrerequisite('node_23');

            nodes.find(n => n.id === 'node_46').addConnection('node_45');
            nodes.find(n => n.id === 'node_45').addPrerequisite('node_46');

            nodes.find(n => n.id === 'node_45').addConnection('node_26');
            nodes.find(n => n.id === 'node_26').addPrerequisite('node_45');

            nodes.find(n => n.id === 'node_26').addConnection('node_29');
            nodes.find(n => n.id === 'node_29').addPrerequisite('node_26');

            nodes.find(n => n.id === 'node_31').addConnection('node_32');
            nodes.find(n => n.id === 'node_32').addPrerequisite('node_31');

            nodes.find(n => n.id === 'node_23').addConnection('node_21');
            nodes.find(n => n.id === 'node_21').addPrerequisite('node_23');


            nodes.find(n => n.id === 'node_32').addConnection('node_21');
            nodes.find(n => n.id === 'node_21').addPrerequisite('node_32');

            nodes.find(n => n.id === 'node_37').addConnection('node_22');
            nodes.find(n => n.id === 'node_22').addPrerequisite('node_37');

            nodes.find(n => n.id === 'node_22').addConnection('node_34');
            nodes.find(n => n.id === 'node_34').addPrerequisite('node_22');


            nodes.find(n => n.id === 'node_34').addConnection('node_21');
            nodes.find(n => n.id === 'node_34').addPrerequisite('node_21');


            nodes.find(n => n.id === 'node_34').addConnection('node_20');
            nodes.find(n => n.id === 'node_20').addPrerequisite('node_34');

            nodes.find(n => n.id === 'node_22').addConnection('node_35');
            nodes.find(n => n.id === 'node_35').addPrerequisite('node_22');

            nodes.find(n => n.id === 'node_22').addConnection('node_36');
            nodes.find(n => n.id === 'node_36').addPrerequisite('node_22');

            nodes.find(n => n.id === 'node_35').addConnection('node_27');
            nodes.find(n => n.id === 'node_27').addPrerequisite('node_35');

            nodes.find(n => n.id === 'node_36').addConnection('node_27');
            nodes.find(n => n.id === 'node_27').addPrerequisite('node_36');

            nodes.find(n => n.id === 'node_19').addConnection('node_27');
            nodes.find(n => n.id === 'node_27').addPrerequisite('node_19');

            nodes.find(n => n.id === 'node_43').addConnection('node_19');
            nodes.find(n => n.id === 'node_19').addPrerequisite('node_43');

            nodes.find(n => n.id === 'node_13').addConnection('node_43');
            nodes.find(n => n.id === 'node_43').addPrerequisite('node_13');

            nodes.find(n => n.id === 'node_38').addConnection('node_40');
            nodes.find(n => n.id === 'node_40').addPrerequisite('node_38');

            nodes.find(n => n.id === 'node_40').addConnection('node_39');
            nodes.find(n => n.id === 'node_39').addPrerequisite('node_40');

            nodes.find(n => n.id === 'node_39').addConnection('node_13');
            nodes.find(n => n.id === 'node_13').addPrerequisite('node_39');

            nodes.find(n => n.id === 'node_40').addConnection('node_14');
            nodes.find(n => n.id === 'node_14').addPrerequisite('node_40');

            nodes.find(n => n.id === 'node_14').addConnection('node_15');
            nodes.find(n => n.id === 'node_15').addPrerequisite('node_14');

            nodes.find(n => n.id === 'node_14').addConnection('node_13');
            nodes.find(n => n.id === 'node_13').addPrerequisite('node_14');

            nodes.find(n => n.id === 'node_40').addConnection('node_16');
            nodes.find(n => n.id === 'node_16').addPrerequisite('node_40');

            nodes.find(n => n.id === 'node_16').addConnection('node_42');
            nodes.find(n => n.id === 'node_42').addPrerequisite('node_16');

            nodes.find(n => n.id === 'node_42').addConnection('node_17');
            nodes.find(n => n.id === 'node_17').addPrerequisite('node_42');

            nodes.find(n => n.id === 'node_17').addConnection('node_28');
            nodes.find(n => n.id === 'node_28').addPrerequisite('node_17');

            nodes.find(n => n.id === 'node_18').addConnection('node_28');
            nodes.find(n => n.id === 'node_28').addPrerequisite('node_18');

            nodes.find(n => n.id === 'node_41').addConnection('node_18');
            nodes.find(n => n.id === 'node_18').addPrerequisite('node_41');

            nodes.find(n => n.id === 'node_15').addConnection('node_41');
            nodes.find(n => n.id === 'node_41').addPrerequisite('node_15');

            nodes.find(n => n.id === 'node_20').addConnection('node_27');
            nodes.find(n => n.id === 'node_27').addPrerequisite('node_20');
        }

        setupConnections();

        // íˆ´íŒ ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€
        let hoveredNode = null;
        let tooltipElement = null;

        // íˆ´íŒ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± í•¨ìˆ˜
        function createTooltip() {
            if (!tooltipElement) {
                tooltipElement = document.createElement('div');
                tooltipElement.style.cssText = `
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00aaff;
            border-radius: 5px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            pointer-events: none;
            z-index: 100;
            display: none;
            white-space: nowrap;
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.3);
        `;
                document.body.appendChild(tooltipElement);
            }
        }

        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ì— í˜¸ë²„ ê°ì§€ ì¶”ê°€
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // ë…¸ë“œ í˜¸ë²„ ê°ì§€
            const newHoveredNode = nodes.find(node => node.isPointInside(x, y));

            if (newHoveredNode !== hoveredNode) {
                hoveredNode = newHoveredNode;
                updateTooltip(e);
            }

            // íˆ´íŒ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (í˜¸ë²„ëœ ë…¸ë“œê°€ ìˆì„ ë•Œ)
            if (hoveredNode && tooltipElement) {
                tooltipElement.style.left = (e.clientX + 10) + 'px';
                tooltipElement.style.top = (e.clientY - 10) + 'px';
            }

            // ê¸°ì¡´ ë“œë˜ê·¸ ë¡œì§ (ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œë‚˜ ì—°ê²° ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”)
            if (coordinateMode || connectionMode) return;

            if (isDragging) {
                const deltaX = (e.clientX - dragStart.x) / camera.zoom;
                const deltaY = (e.clientY - dragStart.y) / camera.zoom;

                camera.x += deltaX;
                camera.y += deltaY;

                dragStart = { x: e.clientX, y: e.clientY };
            }
            if (hoveredNode?.prerequisites) {
                // ì „ì²´ ë…¸ë“œ ì •ë³´ë“¤ nodes
                handleNodeHover(hoveredNode, nodes);
            }


        });

        // ë§ˆìš°ìŠ¤ê°€ ìº”ë²„ìŠ¤ë¥¼ ë²—ì–´ë‚  ë•Œ íˆ´íŒ ìˆ¨ê¸°ê¸°
        canvas.addEventListener('mouseleave', () => {
            hoveredNode = null;
            updateTooltip();
            handleNodeLeave()
        });

        // íˆ´íŒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTooltip(event = null) {
            createTooltip();

            if (hoveredNode && event) {
                const nodeTypeText = hoveredNode.type.charAt(0).toUpperCase() + hoveredNode.type.slice(1);
                const levelText = `${hoveredNode.currentLevel}/${hoveredNode.maxLevel}`;
                const name = hoveredNode.name ?? ''
                tooltipElement.innerHTML = `
            <div style="color: #00aaff; font-weight: bold; font-size: 20px">${name}</div>
            <div style="color: #00ff88; font-size: 20px">ë ˆë²¨: ${levelText}</div>
            <div style="color: #00ff88; font-size: 20px">ë ˆë²¨: ${hoveredNode.id}</div>
        `;

                tooltipElement.style.display = 'block';
                tooltipElement.style.left = (event.clientX + 10) + 'px';
                tooltipElement.style.top = (event.clientY - 10) + 'px';
            } else {
                tooltipElement.style.display = 'none';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íˆ´íŒ ìƒì„±
        window.addEventListener('DOMContentLoaded', createTooltip);

        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œì¸ ê²½ìš°
            if (coordinateMode) {
                collectCoordinate(x, y);
                return;
            }

            // ì—°ê²° ëª¨ë“œì¸ ê²½ìš°
            if (connectionMode) {
                handleConnectionClick(x, y);
                return;
            }

            const clickedNode = nodes.find(node => node.isPointInside(x, y));
            if (clickedNode) {
                if (e.button === 2 || (e.shiftKey && clickedNode.currentLevel > 0)) {
                    // ìš°í´ë¦­(e.button === 2) ë˜ëŠ” Shift+í´ë¦­ìœ¼ë¡œ ë¹„í™œì„±í™”
                    if (clickedNode.deactivate()) {
                        // ë¹„í™œì„±í™” ì„±ê³µ
                    } else {
                        alert('ë‹¤ë¥¸ ë…¸ë“œê°€ ì´ ë…¸ë“œì— ì˜ì¡´í•˜ë¯€ë¡œ ë¹„í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else if (e.button === 0) {
                    // ì¢Œí´ë¦­(e.button === 0)ìœ¼ë¡œ í™œì„±í™”
                    clickedNode.activate();
                }
                return;
            }

            // ë“œë˜ê·¸ëŠ” ì¢Œí´ë¦­ì¼ ë•Œë§Œ
            if (e.button === 0) {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œë‚˜ ì—°ê²° ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
            if (coordinateMode || connectionMode) return;

            if (isDragging) {
                const deltaX = (e.clientX - dragStart.x) / camera.zoom;
                const deltaY = (e.clientY - dragStart.y) / camera.zoom;

                camera.x += deltaX;
                camera.y += deltaY;

                dragStart = { x: e.clientX, y: e.clientY };
            }
        });

        // ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€ - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ í™•ì‹¤íˆ ë§‰ê¸°
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œë‚˜ ì—°ê²° ëª¨ë“œì—ì„œëŠ” ì¤Œ ë¹„í™œì„±í™”
            if (coordinateMode || connectionMode) return;

            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            camera.zoom = Math.max(0.3, Math.min(3, camera.zoom * zoomFactor));
        });

        // ì¢Œí‘œ ìˆ˜ì§‘ ê¸°ëŠ¥ë“¤
        function toggleCoordinateMode() {
            coordinateMode = !coordinateMode;
            const panel = document.getElementById('coordinatePanel');
            const status = document.getElementById('modeStatus');

            if (coordinateMode) {
                panel.style.display = 'block';
                status.textContent = 'í™œì„± (í´ë¦­í•˜ì—¬ ì¢Œí‘œ ìˆ˜ì§‘)';
                status.style.color = '#00ff88';
                canvas.style.cursor = 'crosshair';
            } else {
                panel.style.display = 'none';
                status.textContent = 'ë¹„í™œì„±';
                status.style.color = '#ff6666';
                canvas.style.cursor = 'grab';
            }
        }

        function collectCoordinate(screenX, screenY) {
            // ìŠ¤í¬ë¦° ì¢Œí‘œë¥¼ ì›”ë“œ ì¢Œí‘œë¡œ ë³€í™˜
            const worldX = Math.round((screenX - canvas.width / 2) / camera.zoom - camera.x);
            const worldY = Math.round((screenY - canvas.height / 2) / camera.zoom - camera.y);

            const nodeType = document.getElementById('nodeTypeSelect').value;
            const nodeId = `node_${collectedCoordinates.length + 1}`;

            const coordinate = {
                id: nodeId,
                x: worldX,
                y: worldY,
                type: nodeType,
                screenX: screenX,
                screenY: screenY
            };

            collectedCoordinates.push(coordinate);
            updateCoordinateDisplay();
        }

        function updateCoordinateDisplay() {
            document.getElementById('coordinateCount').textContent = collectedCoordinates.length;

            const list = document.getElementById('coordinateList');
            list.innerHTML = collectedCoordinates.map((coord, index) =>
                `<div style="margin: 2px 0; color: #cccccc;">
                    ${index + 1}. ${coord.id}: (${coord.x}, ${coord.y}) [${coord.type}]
                    <button onclick="removeCoordinate(${index})" style="margin-left: 5px; padding: 1px 5px; font-size: 10px; background: #ff4444; border: none; color: white; border-radius: 2px; cursor: pointer;">âœ–</button>
                </div>`
            ).join('');
        }

        function removeCoordinate(index) {
            collectedCoordinates.splice(index, 1);
            // ID ì¬ì •ë ¬
            collectedCoordinates.forEach((coord, i) => {
                coord.id = `node_${i + 1}`;
            });
            updateCoordinateDisplay();
        }

        function clearCoordinates() {
            if (confirm('ëª¨ë“  ìˆ˜ì§‘ëœ ì¢Œí‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                collectedCoordinates = [];
                updateCoordinateDisplay();
            }
        }

        function exportCoordinates() {
            if (collectedCoordinates.length === 0) {
                alert('ìˆ˜ì§‘ëœ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const code = collectedCoordinates.map(coord =>
                `nodes.push(new SkillNode(${coord.x}, ${coord.y}, '${coord.id}', '${coord.type}', 1));`
            ).join('\n');

            // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    alert(`${collectedCoordinates.length}ê°œ ë…¸ë“œ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }).catch(() => {
                    fallbackCopyToClipboard(code);
                });
            } else {
                fallbackCopyToClipboard(code);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();

            try {
                document.execCommand('copy');
                alert(`${collectedCoordinates.length}ê°œ ë…¸ë“œ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                console.log('ìƒì„±ëœ ë…¸ë“œ ì½”ë“œ:\n', text);
            }

            document.body.removeChild(textarea);
        }

        function generateNodes() {
            if (collectedCoordinates.length === 0) {
                alert('ìˆ˜ì§‘ëœ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (confirm(`${collectedCoordinates.length}ê°œì˜ ë…¸ë“œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë…¸ë“œëŠ” ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                // ê¸°ì¡´ ë…¸ë“œ ì œê±°
                nodes.length = 0;

                // ìƒˆ ë…¸ë“œ ìƒì„±
                collectedCoordinates.forEach(coord => {
                    nodes.push(new SkillNode(coord.x, coord.y, coord.id, coord.type, 1));
                });

                // ì—°ê²° ì„¤ì • ì´ˆê¸°í™”
                setupConnections();

                // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œ ì¢…ë£Œ
                coordinateMode = false;
                document.getElementById('coordinatePanel').style.display = 'none';
                document.getElementById('modeStatus').textContent = 'ë¹„í™œì„±';
                document.getElementById('modeStatus').style.color = '#ff6666';
                canvas.style.cursor = 'grab';
            }
        }

        function loadImage() {
            document.getElementById('imageInput').click();
        }

        function handleImageLoad(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        backgroundImage = img;
                        imageLoaded = true;

                        // ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì¹´ë©”ë¼ ì¡°ì •
                        camera.x = 0;
                        camera.y = 0;
                        camera.zoom = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.8;

                        alert('ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ì—¬ ë…¸ë“œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // UI í•¨ìˆ˜ë“¤
        function updatePoints() {
            const input = document.getElementById('pointsInput');
            const newTotal = parseInt(input.value) || 0;
            const difference = newTotal - (availablePoints + usedPoints);
            availablePoints += difference;
            updateUI();
        }

        function addPoints(amount) {
            availablePoints += amount;
            updateUI();
        }

        function updateUI() {

            document.getElementById('pointsInput').value = availablePoints + usedPoints;
            document.getElementById('usedPoints').textContent = usedPoints;
            document.getElementById('totalPoints').textContent = availablePoints + usedPoints;

            if (usedPoints > availablePoints + usedPoints) {
                document.getElementById('root-point-panel').style = "background-color:red";
            } else {
                document.getElementById('root-point-panel').style = "";
            }
        }

        function resetSkillTree() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ìŠ¤í‚¬ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                nodes.forEach(node => {
                    node.currentLevel = 0;
                });
                availablePoints = availablePoints + usedPoints;
                usedPoints = 0;
                updateUI();
                saveToLocalStorage();
            }
        }

        function fullSize() {
            const skillTreeWrapper = document.querySelector('.skill-tree-wrapper');

            if (skillTreeWrapper) {
                // ì£¼ì„ëœ CSS ìŠ¤íƒ€ì¼ë“¤ì„ ì ìš©
                skillTreeWrapper.style.position = 'fixed';
                skillTreeWrapper.style.top = '0';
                skillTreeWrapper.style.left = '0';
                skillTreeWrapper.style.width = '100vw';
                skillTreeWrapper.style.height = '100vh';
                skillTreeWrapper.style.zIndex = '9999';

                // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€
                skillTreeWrapper.style.position = 'fixed';
                skillTreeWrapper.style.top = '0';
                skillTreeWrapper.style.left = '0';
                skillTreeWrapper.style.width = '100vw';
                skillTreeWrapper.style.height = '100vh';
                skillTreeWrapper.style.zIndex = '9999';
            }
        }

        // ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function saveToLocalStorage() {
            const saveData = {
                nodes: nodes.map(node => ({
                    id: node.id,
                    currentLevel: node.currentLevel
                })),
                availablePoints: availablePoints,
                usedPoints: usedPoints,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('skillTreeSave', JSON.stringify(saveData));
        }

        function loadFromLocalStorage() {
            const saveData = localStorage.getItem('skillTreeSave');
            if (saveData) {
                try {
                    const data = JSON.parse(saveData);

                    data.nodes.forEach(savedNode => {
                        const node = nodes.find(n => n.id === savedNode.id);
                        if (node) {
                            node.currentLevel = savedNode.currentLevel || 0;
                        }
                    });

                    availablePoints = data.availablePoints || 0;
                    usedPoints = data.usedPoints || 0;
                    updateUI();
                } catch (e) {
                    console.error('ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
        }

        function saveToFile() {
            const saveData = {
                nodes: nodes.map(node => ({
                    id: node.id,
                    currentLevel: node.currentLevel
                })),
                availablePoints: availablePoints,
                usedPoints: usedPoints,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `skilltree_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (confirm('í˜„ì¬ ì§„í–‰ìƒí™©ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            nodes.forEach(node => node.currentLevel = 0);

                            data.nodes.forEach(savedNode => {
                                const node = nodes.find(n => n.id === savedNode.id);
                                if (node) {
                                    node.currentLevel = savedNode.currentLevel || 0;
                                }
                            });

                            availablePoints = data.availablePoints || 0;
                            usedPoints = data.usedPoints || 0;
                            updateUI();
                            saveToLocalStorage();

                            alert('íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                        }
                    } catch (error) {
                        alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // ë Œë”ë§
        function render() {
            handleKeyboardMovement();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            if (imageLoaded && backgroundImage) {
                const imgX = (camera.x * camera.zoom) + canvas.width / 2 - (backgroundImage.width * camera.zoom) / 2;
                const imgY = (camera.y * camera.zoom) + canvas.height / 2 - (backgroundImage.height * camera.zoom) / 2;
                const imgWidth = backgroundImage.width * camera.zoom;
                const imgHeight = backgroundImage.height * camera.zoom;

                ctx.drawImage(backgroundImage, imgX, imgY, imgWidth, imgHeight);
            }

            // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆê³  ì—°ê²° ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ë…¸ë“œì™€ ì—°ê²°ì„  ê·¸ë¦¬ê¸°
            if (!coordinateMode && !connectionMode) {
                // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                nodes.forEach(node => {
                    node.connections.forEach(connId => {
                        const connectedNode = nodes.find(n => n.id === connId);
                        if (connectedNode) {
                            drawConnection(node, connectedNode);
                        }
                    });
                });

                // ë…¸ë“œ ê·¸ë¦¬ê¸°
                nodes.forEach(node => node.draw());
                updateNodeOverlayPositions();
            }

            // ì—°ê²° ëª¨ë“œì—ì„œ ë…¸ë“œì™€ ì„ íƒëœ ë…¸ë“œ í‘œì‹œ
            if (connectionMode) {
                // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                nodes.forEach(node => {
                    node.connections.forEach(connId => {
                        const connectedNode = nodes.find(n => n.id === connId);
                        if (connectedNode) {
                            drawConnection(node, connectedNode);
                        }
                    });
                });

                // ë…¸ë“œ ê·¸ë¦¬ê¸° (ì„ íƒëœ ë…¸ë“œëŠ” í•˜ì´ë¼ì´íŠ¸)
                nodes.forEach(node => {
                    if (node === selectedNode) {
                        // ì„ íƒëœ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸
                        const pos = node.getScreenPosition();
                        const scaledRadius = node.radius * camera.zoom;

                        ctx.save();
                        ctx.shadowColor = '#ffaa00';
                        ctx.shadowBlur = 20;
                        ctx.strokeStyle = '#ffaa00';
                        ctx.lineWidth = 4;
                        ctx.beginPath();

                        if (node.type === 'keystone') {
                            ctx.arc(pos.x, pos.y, scaledRadius + 5, 0, Math.PI * 2);
                        } else {
                            for (let i = 0; i < 6; i++) {
                                const angle = (Math.PI / 3) * i;
                                const x = pos.x + Math.cos(angle) * (scaledRadius + 5);
                                const y = pos.y + Math.sin(angle) * (scaledRadius + 5);
                                if (i === 0) {
                                    ctx.moveTo(x, y);
                                } else {
                                    ctx.lineTo(x, y);
                                }
                            }
                            ctx.closePath();
                        }
                        ctx.stroke();
                        ctx.restore();
                    }
                    node.draw();
                });

                // ì—°ê²° ëª¨ë“œ ì•ˆë‚´ í…ìŠ¤íŠ¸
                ctx.fillStyle = '#00ffff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                if (selectedNode) {
                    ctx.fillText(`${selectedNode.id} ì„ íƒë¨ - ì—°ê²°í•  ë…¸ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”`, canvas.width / 2, 50);
                } else {
                    ctx.fillText('ì—°ê²° ëª¨ë“œ - ì²« ë²ˆì§¸ ë…¸ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”', canvas.width / 2, 50);
                }
            }

            // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œì—ì„œ ìˆ˜ì§‘ëœ ì ë“¤ í‘œì‹œ
            if (coordinateMode) {
                collectedCoordinates.forEach((coord, index) => {
                    const screenPos = {
                        x: (coord.x + camera.x) * camera.zoom + canvas.width / 2,
                        y: (coord.y + camera.y) * camera.zoom + canvas.height / 2
                    };

                    let radius, color;
                    switch (coord.type) {
                        case 'small': radius = 8; color = '#00aaff'; break;
                        case 'notable': radius = 14; color = '#ffaa00'; break;
                        case 'keystone': radius = 22; color = '#ff6666'; break;
                    }

                    ctx.save();
                    ctx.shadowColor = color;
                    ctx.shadowBlur = 8;
                    ctx.strokeStyle = color;
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(screenPos.x, screenPos.y, radius * camera.zoom, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();

                    // ë²ˆí˜¸ í‘œì‹œ
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#ffffff';
                    ctx.font = `${12 * camera.zoom}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText((index + 1).toString(), screenPos.x, screenPos.y);

                    ctx.restore();
                });

                // ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œ ì•ˆë‚´ í…ìŠ¤íŠ¸
                ctx.fillStyle = '#00ffff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ì¢Œí‘œ ìˆ˜ì§‘ ëª¨ë“œ - ë…¸ë“œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”', canvas.width / 2, 50);
            }

            requestAnimationFrame(render);
        }

        // ì—°ê²° ëª¨ë“œ ê¸°ëŠ¥ë“¤
        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            const panel = document.getElementById('connectionPanel');
            const status = document.getElementById('connectionStatus');

            if (connectionMode) {
                // ë‹¤ë¥¸ ëª¨ë“œë“¤ ë¹„í™œì„±í™”
                if (coordinateMode) {
                    coordinateMode = false;
                    document.getElementById('coordinatePanel').style.display = 'none';
                }

                panel.style.display = 'block';
                status.textContent = 'í™œì„± (ë…¸ë“œë¥¼ í´ë¦­í•˜ì—¬ ì—°ê²°)';
                status.style.color = '#00ff88';
                canvas.style.cursor = 'pointer';
                selectedNode = null;
                updateConnectionDisplay();
            } else {
                panel.style.display = 'none';
                status.textContent = 'ë¹„í™œì„±';
                status.style.color = '#ff6666';
                canvas.style.cursor = 'grab';
                selectedNode = null;
            }
        }

        function handleConnectionClick(screenX, screenY) {
            const clickedNode = nodes.find(node => node.isPointInside(screenX, screenY));

            if (!clickedNode) return;

            if (!selectedNode) {
                // ì²« ë²ˆì§¸ ë…¸ë“œ ì„ íƒ
                selectedNode = clickedNode;
                document.getElementById('selectedNode').textContent = clickedNode.id;
                document.getElementById('selectedNode').style.color = '#ffaa00';
            } else if (selectedNode === clickedNode) {
                // ê°™ì€ ë…¸ë“œ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
                selectedNode = null;
                document.getElementById('selectedNode').textContent = 'ì—†ìŒ';
                document.getElementById('selectedNode').style.color = '#00ff88';
            } else {
                // ë‘ ë²ˆì§¸ ë…¸ë“œ ì„ íƒ - ì—°ê²° ìƒì„±
                createConnection(selectedNode, clickedNode);
                selectedNode = null;
                document.getElementById('selectedNode').textContent = 'ì—†ìŒ';
                document.getElementById('selectedNode').style.color = '#00ff88';
            }
        }

        function createConnection(fromNode, toNode) {
            const bidirectional = document.getElementById('bidirectionalCheck').checked;

            // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const existingConnection = allConnections.find(conn =>
                (conn.from === fromNode.id && conn.to === toNode.id) ||
                (conn.to === fromNode.id && conn.from === toNode.id)
            );

            if (existingConnection) {
                alert('ì´ë¯¸ ì—°ê²°ëœ ë…¸ë“œì…ë‹ˆë‹¤.');
                return;
            }

            // ì‹¤ì œ ë…¸ë“œì— ì—°ê²° ì¶”ê°€
            fromNode.addConnection(toNode.id);
            toNode.addPrerequisite(fromNode.id);

            // ì—°ê²° ê¸°ë¡
            const connection = {
                from: fromNode.id,
                to: toNode.id,
                bidirectional: bidirectional
            };
            allConnections.push(connection);

            if (bidirectional) {
                // ì–‘ë°©í–¥ ì—°ê²°
                toNode.addConnection(fromNode.id);
                fromNode.addPrerequisite(toNode.id);
            }

            updateConnectionDisplay();
        }

        function updateConnectionDisplay() {
            document.getElementById('connectionCount').textContent = allConnections.length;

            const list = document.getElementById('connectionList');
            list.innerHTML = allConnections.map((conn, index) =>
                `<div style="margin: 2px 0; color: #cccccc;">
                    ${index + 1}. ${conn.from} â†’ ${conn.to} ${conn.bidirectional ? '(ì–‘ë°©í–¥)' : ''}
                    <button onclick="removeConnection(${index})" style="margin-left: 5px; padding: 1px 5px; font-size: 10px; background: #ff4444; border: none; color: white; border-radius: 2px; cursor: pointer;">âœ–</button>
                </div>`
            ).join('');
        }

        function removeConnection(index) {
            const conn = allConnections[index];

            // ì‹¤ì œ ë…¸ë“œì—ì„œ ì—°ê²° ì œê±°
            const fromNode = nodes.find(n => n.id === conn.from);
            const toNode = nodes.find(n => n.id === conn.to);

            if (fromNode && toNode) {
                // ì—°ê²°ê³¼ ì „ì œì¡°ê±´ ì œê±°
                fromNode.connections = fromNode.connections.filter(id => id !== conn.to);
                toNode.prerequisites = toNode.prerequisites.filter(id => id !== conn.from);

                if (conn.bidirectional) {
                    toNode.connections = toNode.connections.filter(id => id !== conn.from);
                    fromNode.prerequisites = fromNode.prerequisites.filter(id => id !== conn.to);
                }
            }

            // ì—°ê²° ê¸°ë¡ì—ì„œ ì œê±°
            allConnections.splice(index, 1);
            updateConnectionDisplay();
        }

        function clearAllConnections() {
            if (confirm('ëª¨ë“  ì—°ê²°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ëª¨ë“  ë…¸ë“œì˜ ì—°ê²°ê³¼ ì „ì œì¡°ê±´ ì´ˆê¸°í™”
                nodes.forEach(node => {
                    node.connections = [];
                    node.prerequisites = [];
                });

                allConnections = [];
                updateConnectionDisplay();
                alert('ëª¨ë“  ì—°ê²°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function exportConnections() {
            if (allConnections.length === 0) {
                alert('ìƒì„±ëœ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let code = 'function setupConnections() {\n';

            allConnections.forEach(conn => {
                code += `    nodes.find(n => n.id === '${conn.from}').addConnection('${conn.to}');\n`;
                code += `    nodes.find(n => n.id === '${conn.to}').addPrerequisite('${conn.from}');\n`;

                if (conn.bidirectional) {
                    code += `    nodes.find(n => n.id === '${conn.to}').addConnection('${conn.from}');\n`;
                    code += `    nodes.find(n => n.id === '${conn.from}').addPrerequisite('${conn.to}');\n`;
                }
                code += '\n';
            });

            code += '}';

            // í´ë¦½ë³´ë“œ ë³µì‚¬
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    alert(`${allConnections.length}ê°œ ì—°ê²° ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }).catch(() => {
                    fallbackCopyToClipboard(code);
                });
            } else {
                fallbackCopyToClipboard(code);
            }
        }


        // ì¢Œí‘œ ìˆ˜ì§‘ ê¸°ëŠ¥ë“¤
        function toggleCoordinateMode() {
            coordinateMode = !coordinateMode;
            const panel = document.getElementById('coordinatePanel');
            const status = document.getElementById('modeStatus');

            if (coordinateMode) {
                panel.style.display = 'block';
                status.textContent = 'í™œì„± (í´ë¦­í•˜ì—¬ ì¢Œí‘œ ìˆ˜ì§‘)';
                status.style.color = '#00ff88';
                canvas.style.cursor = 'crosshair';
            } else {
                panel.style.display = 'none';
                status.textContent = 'ë¹„í™œì„±';
                status.style.color = '#ff6666';
                canvas.style.cursor = 'grab';
            }
        }

        // ì—°ê²° ëª¨ë“œ ê¸°ëŠ¥ë“¤
        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            const panel = document.getElementById('connectionPanel');
            const status = document.getElementById('connectionStatus');

            if (connectionMode) {
                // ë‹¤ë¥¸ ëª¨ë“œë“¤ ë¹„í™œì„±í™”
                if (coordinateMode) {
                    coordinateMode = false;
                    document.getElementById('coordinatePanel').style.display = 'none';
                }

                panel.style.display = 'block';
                status.textContent = 'í™œì„± (ë…¸ë“œë¥¼ í´ë¦­í•˜ì—¬ ì—°ê²°)';
                status.style.color = '#00ff88';
                canvas.style.cursor = 'pointer';
                selectedNode = null;
                updateConnectionDisplay();
            } else {
                panel.style.display = 'none';
                status.textContent = 'ë¹„í™œì„±';
                status.style.color = '#ff6666';
                canvas.style.cursor = 'grab';
                selectedNode = null;
            }
        }

        function handleConnectionClick(screenX, screenY) {
            const clickedNode = nodes.find(node => node.isPointInside(screenX, screenY));

            if (!clickedNode) return;

            if (!selectedNode) {
                // ì²« ë²ˆì§¸ ë…¸ë“œ ì„ íƒ
                selectedNode = clickedNode;
                document.getElementById('selectedNode').textContent = clickedNode.id;
                document.getElementById('selectedNode').style.color = '#ffaa00';
            } else if (selectedNode === clickedNode) {
                // ê°™ì€ ë…¸ë“œ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
                selectedNode = null;
                document.getElementById('selectedNode').textContent = 'ì—†ìŒ';
                document.getElementById('selectedNode').style.color = '#00ff88';
            } else {
                // ë‘ ë²ˆì§¸ ë…¸ë“œ ì„ íƒ - ì—°ê²° ìƒì„±
                createConnection(selectedNode, clickedNode);
                selectedNode = null;
                document.getElementById('selectedNode').textContent = 'ì—†ìŒ';
                document.getElementById('selectedNode').style.color = '#00ff88';
            }
        }

        function createConnection(fromNode, toNode) {
            const bidirectional = document.getElementById('bidirectionalCheck').checked;

            // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const existingConnection = allConnections.find(conn =>
                (conn.from === fromNode.id && conn.to === toNode.id) ||
                (conn.to === fromNode.id && conn.from === toNode.id)
            );

            if (existingConnection) {
                alert('ì´ë¯¸ ì—°ê²°ëœ ë…¸ë“œì…ë‹ˆë‹¤.');
                return;
            }

            // ì‹¤ì œ ë…¸ë“œì— ì—°ê²° ì¶”ê°€
            fromNode.addConnection(toNode.id);
            toNode.addPrerequisite(fromNode.id);

            // ì—°ê²° ê¸°ë¡
            const connection = {
                from: fromNode.id,
                to: toNode.id,
                bidirectional: bidirectional
            };
            allConnections.push(connection);

            if (bidirectional) {
                // ì–‘ë°©í–¥ ì—°ê²°
                toNode.addConnection(fromNode.id);
                fromNode.addPrerequisite(toNode.id);
            }

            updateConnectionDisplay();
        }

        function updateConnectionDisplay() {
            document.getElementById('connectionCount').textContent = allConnections.length;

            const list = document.getElementById('connectionList');
            list.innerHTML = allConnections.map((conn, index) =>
                `<div style="margin: 2px 0; color: #cccccc;">
            ${index + 1}. ${conn.from} â†’ ${conn.to} ${conn.bidirectional ? '(ì–‘ë°©í–¥)' : ''}
            <button onclick="removeConnection(${index})" style="margin-left: 5px; padding: 1px 5px; font-size: 10px; background: #ff4444; border: none; color: white; border-radius: 2px; cursor: pointer;">âœ–</button>
        </div>`
            ).join('');
        }

        function removeConnection(index) {
            const conn = allConnections[index];

            // ì‹¤ì œ ë…¸ë“œì—ì„œ ì—°ê²° ì œê±°
            const fromNode = nodes.find(n => n.id === conn.from);
            const toNode = nodes.find(n => n.id === conn.to);

            if (fromNode && toNode) {
                // ì—°ê²°ê³¼ ì „ì œì¡°ê±´ ì œê±°
                fromNode.connections = fromNode.connections.filter(id => id !== conn.to);
                toNode.prerequisites = toNode.prerequisites.filter(id => id !== conn.from);

                if (conn.bidirectional) {
                    toNode.connections = toNode.connections.filter(id => id !== conn.from);
                    fromNode.prerequisites = fromNode.prerequisites.filter(id => id !== conn.to);
                }
            }

            // ì—°ê²° ê¸°ë¡ì—ì„œ ì œê±°
            allConnections.splice(index, 1);
            updateConnectionDisplay();
        }

        function clearAllConnections() {
            if (confirm('ëª¨ë“  ì—°ê²°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ëª¨ë“  ë…¸ë“œì˜ ì—°ê²°ê³¼ ì „ì œì¡°ê±´ ì´ˆê¸°í™”
                nodes.forEach(node => {
                    node.connections = [];
                    node.prerequisites = [];
                });

                allConnections = [];
                updateConnectionDisplay();
                alert('ëª¨ë“  ì—°ê²°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function exportConnections() {
            if (allConnections.length === 0) {
                alert('ìƒì„±ëœ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let code = 'function setupConnections() {\n';

            allConnections.forEach(conn => {
                code += `    nodes.find(n => n.id === '${conn.from}').addConnection('${conn.to}');\n`;
                code += `    nodes.find(n => n.id === '${conn.to}').addPrerequisite('${conn.from}');\n`;

                if (conn.bidirectional) {
                    code += `    nodes.find(n => n.id === '${conn.to}').addConnection('${conn.from}');\n`;
                    code += `    nodes.find(n => n.id === '${conn.from}').addPrerequisite('${conn.to}');\n`;
                }
                code += '\n';
            });

            code += '}';

            // í´ë¦½ë³´ë“œ ë³µì‚¬
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    alert(`${allConnections.length}ê°œ ì—°ê²° ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }).catch(() => {
                    fallbackCopyToClipboard(code);
                });
            } else {
                fallbackCopyToClipboard(code);
            }
        }

        // ì„ í–‰ ë…¸ë“œë“¤ì„ ìƒ‰ì¹ í•˜ëŠ” í•¨ìˆ˜
        function colorPrerequisites(hoveredNode, nodes) {
            if (hoveredNode?.prerequisites) {

                // 1. hoveredNode.prerequisitesì—ì„œ ì„ í–‰ ë…¸ë“œ IDë“¤ì„ ê°€ì ¸ì˜´
                const prerequisiteIds = hoveredNode.prerequisites;

                // 2. nodes ë°°ì—´ì—ì„œ í•´ë‹¹ IDë¥¼ ê°€ì§„ ë…¸ë“œë“¤ì„ ì°¾ìŒ
                prerequisiteIds.forEach(prereqId => {
                    // nodes ë°°ì—´ì—ì„œ idê°€ ì¼ì¹˜í•˜ëŠ” ë…¸ë“œ ì°¾ê¸°
                    const prereqNode = nodes.find(node => node.id === prereqId);

                    if (prereqNode) {
                        // 3. DOMì—ì„œ í•´ë‹¹ ë…¸ë“œ ìš”ì†Œ ì°¾ê¸° (data-node-id ì†ì„± ì‚¬ìš©)
                        const nodeElement = document.querySelector(`[data-node-id="${prereqId}"]`);

                        if (nodeElement) {
                            // 4. ìƒ‰ì¹ í•˜ê¸° (ë¹¨ê°„ í…Œë‘ë¦¬ ì¶”ê°€)
                            nodeElement.classList.add('prerequisite-highlighted');
                        }
                    }
                });
            }
        }
        function createNodeOverlays() {
            // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
            document.querySelectorAll('.node-overlay').forEach(el => el.remove());

            const skillTreeWrapper = document.querySelector('.skill-tree-wrapper');

            nodes.forEach(node => {
                const overlay = document.createElement('div');
                overlay.setAttribute('data-node-id', node.id);
                overlay.className = 'node-overlay';
                overlay.style.cssText = `
            position: absolute;
            pointer-events: ${isDragging ? 'none' : 'auto'};
            background: transparent;
            border-radius: 50%;
            z-index: 10;
            transition: all 0.3s ease;
        `;

                // âœ… ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì™„ì „ ìˆ˜ì •
                overlay.addEventListener('mouseenter', (e) => {
                    // ë“œë˜ê·¸ ì¤‘ì´ë©´ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
                    if (isDragging) return;

                    e.stopPropagation();

                    // âœ… íˆ´íŒ ì„¤ì • (ë¹ ì ¸ìˆë˜ ë¶€ë¶„)
                    hoveredNode = node;
                    updateTooltip(e);

                    // ì„ í–‰ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸
                    if (node?.prerequisites && node.prerequisites.length > 0) {
                        handleNodeHover(node, nodes);
                    }
                });

                overlay.addEventListener('mousemove', (e) => {
                    // ë“œë˜ê·¸ ì¤‘ì´ë©´ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
                    if (isDragging) return;

                    e.stopPropagation();

                    // âœ… íˆ´íŒ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ë¹ ì ¸ìˆë˜ ë¶€ë¶„)
                    if (hoveredNode && tooltipElement && tooltipElement.style.display === 'block') {
                        tooltipElement.style.left = (e.clientX + 10) + 'px';
                        tooltipElement.style.top = (e.clientY - 10) + 'px';
                    }
                });

                overlay.addEventListener('mouseleave', (e) => {
                    // ë“œë˜ê·¸ ì¤‘ì´ë©´ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
                    if (isDragging) return;

                    e.stopPropagation();

                    // âœ… íˆ´íŒ ì œê±° (ë¹ ì ¸ìˆë˜ ë¶€ë¶„)
                    hoveredNode = null;
                    updateTooltip();

                    // ì„ í–‰ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                    handleNodeLeave();
                });

                // í´ë¦­ ì´ë²¤íŠ¸ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ì§€ë§Œ stopPropagation ì¶”ê°€)
                overlay.addEventListener('mousedown', (e) => {
                    e.stopPropagation();

                    if (e.button === 2 || (e.shiftKey && node.currentLevel > 0)) {
                        // ìš°í´ë¦­ ë˜ëŠ” Shift+í´ë¦­ìœ¼ë¡œ ë¹„í™œì„±í™”
                        if (node.deactivate()) {
                            // ë¹„í™œì„±í™” ì„±ê³µ
                        } else {
                            alert('ë‹¤ë¥¸ ë…¸ë“œê°€ ì´ ë…¸ë“œì— ì˜ì¡´í•˜ë¯€ë¡œ ë¹„í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } else if (e.button === 0) {
                        // ì¢Œí´ë¦­ìœ¼ë¡œ í™œì„±í™”
                        node.activate();
                    }
                    e.preventDefault();
                });

                overlay.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });

                skillTreeWrapper.appendChild(overlay);
            });
        }

        // 2. ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateNodeOverlayPositions() {
            nodes.forEach(node => {
                const overlay = document.querySelector(`[data-node-id="${node.id}"]`);
                if (overlay) {
                    const pos = node.getScreenPosition();
                    const scaledRadius = node.radius * camera.zoom;

                    overlay.style.left = (pos.x - scaledRadius) + 'px';
                    overlay.style.top = (pos.y - scaledRadius) + 'px';
                    overlay.style.width = (scaledRadius * 2) + 'px';
                    overlay.style.height = (scaledRadius * 2) + 'px';
                }
            });
        }
        // ëª¨ë“  ìƒ‰ì¹  ì œê±°í•˜ëŠ” í•¨ìˆ˜
        function clearPrerequisiteColors() {
            document.querySelectorAll('.prerequisite-highlighted').forEach(element => {
                element.classList.remove('prerequisite-highlighted');
            });
        }
        function addPrerequisiteColorStyles() {
            const style = document.createElement('style');
            style.textContent = `
        .prerequisite-highlighted {
            border: 3px solid #ff0000 !important;
            background-color: rgba(255, 0, 0, 0.2) !important;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            transition: all 0.3s ease;
        }
    `;
            document.head.appendChild(style);
        }

        // ì‚¬ìš© ì˜ˆì‹œ
        function handleNodeHover(hoveredNode, nodes) {
            // ê¸°ì¡´ ìƒ‰ì¹  ì œê±°
            clearPrerequisiteColors();

            // ìƒˆë¡œìš´ ì„ í–‰ ë…¸ë“œë“¤ ìƒ‰ì¹ 
            colorPrerequisites(hoveredNode, nodes);
        }

        function handleNodeLeave() {
            // ë§ˆìš°ìŠ¤ê°€ ë– ë‚¬ì„ ë•Œ ëª¨ë“  ìƒ‰ì¹  ì œê±°
            clearPrerequisiteColors();
        }

        function calculateDday(targetDateStr) {
            const today = new Date();
            const targetDate = new Date(targetDateStr);

            // ì˜¤ëŠ˜ ë‚ ì§œì—ì„œ ì‹œê°„ ì œê±° (00:00:00 ê¸°ì¤€)
            today.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);

            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // í•˜ë£¨ëŠ” 86400000ms

            return diffDays;
        }

        // ì´ˆê¸°í™” (CSS ìŠ¤íƒ€ì¼ ì¶”ê°€)
        addPrerequisiteColorStyles();
        // ì´ˆê¸°í™”
        loadFromLocalStorage();
        updateUI();

        createNodeOverlays();

        render();

        window.addEventListener('beforeunload', saveToLocalStorage);
    </script>
</div>

</html>